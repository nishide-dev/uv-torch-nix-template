# Copier template configuration for uv-torch-nix-template
# This is an extension template that adds PyTorch/CUDA support to uv-nix-template

_min_copier_version: "9.0.0"

# ============================================================================
# User questions - ProjectåŸºæœ¬æƒ…å ±
# ============================================================================

project_name:
  type: str
  help: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Enterã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ä½¿ç”¨)"
  default: "{{ _copier_conf.dst_path.name }}"

package_name:
  type: str
  help: "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (Pythonã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆåã€é€šå¸¸ã¯ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹)"
  default: "{{ project_name | replace('-', '_') }}"

description:
  type: str
  help: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®çŸ­ã„èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  default: "A PyTorch/CUDA deep learning project"

author_name:
  type: str
  help: "ä½œè€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  default: "Your Name"

author_email:
  type: str
  help: "ä½œè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
  default: "your.email@example.com"

python_version:
  type: str
  help: "å¯¾è±¡ã¨ã™ã‚‹æœ€å°Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„"
  default: "3.12"
  choices:
    - "3.10"
    - "3.11"
    - "3.12"
    - "3.13"

# ============================================================================
# User questions - é–‹ç™ºãƒ„ãƒ¼ãƒ«è¨­å®š
# ============================================================================

use_ruff:
  type: bool
  help: "Ruff (é«˜é€Ÿlinter/formatter) ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ"
  default: true

use_ty:
  type: bool
  help: "ty (é«˜é€Ÿå‹ãƒã‚§ãƒƒã‚«ãƒ¼ by Astral) ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ"
  default: true

use_pytest:
  type: bool
  help: "Pytest (ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯) ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ"
  default: true

use_github_actions:
  type: bool
  help: "GitHub Actions CI/CDã‚’è¨­å®šã—ã¾ã™ã‹ï¼Ÿ"
  default: true

use_nix:
  type: bool
  help: "Nix + direnv ã«ã‚ˆã‚‹é–‹ç™ºç’°å¢ƒç®¡ç†ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ"
  default: true

setup_direnv_hook:
  type: bool
  help: "ã‚·ã‚§ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ~/.bashrc or ~/.zshrcï¼‰ã«direnv hookã‚’è‡ªå‹•è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ"
  default: false
  when: "{{ use_nix }}"

# ============================================================================
# User questions - PyTorch/CUDA configuration
# ============================================================================
#
# ã€PyTorchå…¬å¼ã‚µãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‘
# https://pytorch.org/get-started/previous-versions/
#
# ãƒ—ãƒªã‚»ãƒƒãƒˆã‹ã‚‰é¸æŠã™ã‚‹ã“ã¨ã§ã€äº’æ›æ€§ã®ã‚ã‚‹çµ„ã¿åˆã‚ã›ã‚’è‡ªå‹•è¨­å®šã§ãã¾ã™ã€‚
# Customã‚’é¸æŠã—ãŸå ´åˆã¯ã€æ‰‹å‹•ã§äº’æ›æ€§ã®ã‚ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
# ============================================================================

pytorch_cuda_preset:
  type: str
  help: "PyTorch + CUDAã®ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„"
  default: "pytorch-2.5.1-cuda-12.4"
  choices:
    "PyTorch 2.5.1 + CUDA 12.4 (æœ€æ–°ãƒ»æ¨å¥¨)": "pytorch-2.5.1-cuda-12.4"
    "PyTorch 2.5.1 + CUDA 12.1": "pytorch-2.5.1-cuda-12.1"
    "PyTorch 2.5.1 + CUDA 11.8": "pytorch-2.5.1-cuda-11.8"
    "PyTorch 2.4.1 + CUDA 12.4": "pytorch-2.4.1-cuda-12.4"
    "PyTorch 2.4.1 + CUDA 12.1": "pytorch-2.4.1-cuda-12.1"
    "PyTorch 2.4.1 + CUDA 11.8": "pytorch-2.4.1-cuda-11.8"
    "PyTorch 2.3.1 + CUDA 12.1": "pytorch-2.3.1-cuda-12.1"
    "PyTorch 2.3.1 + CUDA 11.8": "pytorch-2.3.1-cuda-11.8"
    "Custom (æ‰‹å‹•è¨­å®š)": "custom"

pytorch_version:
  type: str
  help: "PyTorchãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 2.5.1, 2.4.1, 2.3.1ï¼‰"
  default: "2.5.1"
  when: "{{ pytorch_cuda_preset == 'custom' }}"

cuda_version:
  type: str
  help: "CUDAãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 12.4, 12.1, 11.8ï¼‰ï½œNixOS: docs/NIX_SETUP.mdå‚ç…§"
  default: "12.4"
  when: "{{ pytorch_cuda_preset == 'custom' }}"

cudnn_version:
  type: str
  help: "cuDNNãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 9.1.0, 8.9.7ï¼‰"
  default: "9.1.0"
  when: "{{ pytorch_cuda_preset == 'custom' }}"

pytorch_cuda_arch:
  type: str
  help: "PyTorch CUDA architectureã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆcu124, cu121, cu118ãªã©ã€‚ç©ºç™½ã®å ´åˆã¯cuda_versionã‹ã‚‰è‡ªå‹•ç”Ÿæˆï¼‰"
  default: ""

use_torchvision:
  type: bool
  help: "torchvisionã‚’å«ã‚ã¾ã™ã‹ï¼Ÿ"
  default: true

use_torchaudio:
  type: bool
  help: "torchaudioã‚’å«ã‚ã¾ã™ã‹ï¼Ÿ"
  default: false

additional_cuda_libs:
  type: str
  help: "è¿½åŠ ã®CUDAãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã€ä¾‹: nccl,cutlass,libcusparseï¼‰ï½œåˆ†æ•£å­¦ç¿’ã‚„ã‚¹ãƒ‘ãƒ¼ã‚¹æ¼”ç®—ã«å¿…è¦"
  default: ""

# ============================================================================
# File/directory exclusion settings
# ============================================================================

_exclude:
  - "copier.yml"
  - "copier.yaml"
  - ".git"
  - ".venv"
  - "__pycache__"
  - "*.pyc"
  - ".pytest_cache"
  - ".mypy_cache"
  - ".ruff_cache"
  - "uv.lock"
  - "dist"
  - "build"
  - "*.egg-info"
  - "{% if not use_ruff %}ruff.toml.jinja{% endif %}"  # Ruffæœªä½¿ç”¨ã®å ´åˆã¯é™¤å¤–
  - "{% if not use_nix %}flake.nix.jinja{% endif %}"  # Nixæœªä½¿ç”¨ã®å ´åˆã¯é™¤å¤–
  - "{% if not use_nix %}.envrc{% endif %}"  # Nixæœªä½¿ç”¨ã®å ´åˆã¯é™¤å¤–
  - "{% if not use_nix %}docs{% endif %}"  # Nixæœªä½¿ç”¨ã®å ´åˆã¯docsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå…¨ä½“ã‚’é™¤å¤–
  - "{% if not use_github_actions %}.github{% endif %}"  # GitHub Actionsæœªä½¿ç”¨ã®å ´åˆã¯é™¤å¤–

# ============================================================================
# Post-generation tasks
# ============================================================================

_tasks:
  - "git init -b main"
  - "git add ."
  - |
    {% if use_nix and setup_direnv_hook %}
    # ã‚·ã‚§ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®direnv hookè¿½åŠ 
    for rcfile in ~/.bashrc ~/.zshrc; do
      if [ -f "$rcfile" ] && ! grep -q "direnv hook" "$rcfile"; then
        shell=$(basename "$rcfile" | sed 's/^\.//;s/rc$//')
        echo 'eval "$(direnv hook '"$shell"')"' >> "$rcfile"
        echo "âœ… Added direnv hook to $rcfile"
      fi
    done
    {% endif %}
  - "uv venv"
  - "uv lock"
  - "git add uv.lock"
  - "uv sync"
  - |
    set -e
    {% if use_ruff %}
    echo "ğŸ” Ruff check..."
    uv run ruff check . --fix
    echo "âœ¨ Ruff format..."
    uv run ruff format .
    {% endif %}
    {% if use_ty %}
    echo "ğŸ” Type checking..."
    uv run ty check
    {% endif %}
    {% if use_pytest %}
    echo "ğŸ§ª Running tests..."
    uv run pytest
    {% endif %}
    echo "âœ… All quality checks passed!"

  # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - |
    echo "
    ============================================================
    ğŸ‰ PyTorch/CUDA ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼
    ============================================================

    ğŸ“¦ Project: {{ project_name }}
    ğŸ”¥ PyTorch: {{ pytorch_version }} + CUDA {{ cuda_version }}

    æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:
      1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•:
         cd {{ project_name }}

      2. åˆå›ã‚³ãƒŸãƒƒãƒˆ (ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ—¢ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ¸ˆã¿):
         git commit -m \"chore: initial commit\"

      3. é–‹ç™ºã‚’é–‹å§‹ (ä»®æƒ³ç’°å¢ƒã¯æ—¢ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿):
         uv add <package-name>      # ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 
         uv run pytest              # ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
         uv run ruff format .       # ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
         uv run ty check            # å‹ãƒã‚§ãƒƒã‚¯

      4. CUDAå‹•ä½œç¢ºèª:
         uv run python -c 'import torch; print(f\"CUDA: {torch.cuda.is_available()}\")'

    {% if use_nix %}
    ğŸ“š NixOS users: docs/NIX_SETUP.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„
    {% endif %}
    ğŸ“– è©³ç´°: docs/CUDA_SETUP.md

    ============================================================
    "

# ============================================================================
# Template metadata
# ============================================================================

_metadata:
  template_version: "0.1.0"
  base_template: "uv-nix-template"
  description: "PyTorch/CUDA extension for uv-nix-template"
