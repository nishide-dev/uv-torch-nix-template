{# Extract values from preset #}
{% if pytorch_cuda_preset == 'pytorch-2.9.0-cuda-12.6' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.9.0-cuda-13.0' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '13.0' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.6' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.8' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.8' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-12.6' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-11.8' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.6.0-cuda-12.4' %}
  {% set pytorch_version = '2.6.0' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.6.0-cuda-11.8' %}
  {% set pytorch_version = '2.6.0' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-12.4' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-12.1' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-11.8' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-12.4' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-12.1' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-11.8' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.3.1-cuda-12.1' %}
  {% set pytorch_version = '2.3.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.3.1-cuda-11.8' %}
  {% set pytorch_version = '2.3.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% else %}
  {% set pytorch_version = pytorch_version %}
  {% set cuda_version = cuda_version %}
  {% set cudnn_version = cudnn_version %}
{% endif %}
# Reference: https://github.com/astral-sh/uv-docker-example/blob/main/multistage.Dockerfile
# Development version with UV tools, CUDA support, and development dependencies included

# Use NVIDIA CUDA image as base for GPU support
# PyTorch {{ pytorch_version }} + CUDA {{ cuda_version }} + cuDNN {{ cudnn_version }}
ARG CUDA_VERSION={{ cuda_version }}
ARG CUDNN_MAJOR={{ cudnn_version.split('.')[0] }}
FROM nvidia/cuda:${CUDA_VERSION}-cudnn${CUDNN_MAJOR}-devel-ubuntu22.04

# タイムゾーン設定を事前に指定して対話プロンプトを回避
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Tokyo \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# Set environment variables for UV
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy
ENV UV_PYTHON_DOWNLOADS=0

# ホストのユーザー名、ユーザーID、グループIDをビルド引数として受け取る
ARG USERNAME=appuser
ARG USER_ID=1000
ARG GROUP_ID=1000

# 基本パッケージとロケール設定
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    locales \
    curl \
    build-essential \
    git \
    && echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen \
    && locale-gen \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Python {{ python_version }} のインストール
RUN add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python{{ python_version }} \
    python{{ python_version }}-venv \
    python{{ python_version }}-dev \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python{{ python_version }} 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python{{ python_version }} 1 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Copy UV from the official image
COPY --from=ghcr.io/astral-sh/uv:0.6.6 /uv /uvx /bin/

# ユーザーとグループを指定されたIDで作成
RUN groupadd -g ${GROUP_ID} ${USERNAME} && \
    useradd -u ${USER_ID} -g ${USERNAME} -s /bin/bash -m ${USERNAME}

# Allow user to run SSH daemon and sudo without password
RUN apt-get update && apt-get install -y sudo openssh-server && \
    mkdir -p /run/sshd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config && \
    sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    echo "Port 2222" >> /etc/ssh/sshd_config && \
    mkdir -p /etc/sudoers.d && \
    echo "$USERNAME ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/nopasswd && \
    chmod 0440 /etc/sudoers.d/nopasswd && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Create cache directory with proper permissions for UV
RUN mkdir -p /home/$USERNAME/.cache/uv && chown -R $USERNAME:$USERNAME /home/$USERNAME

# Install additional development tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    procps \
    vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the entire project for development
COPY . /app

# Give user ownership of virtual environment directory and project files
RUN mkdir -p /app/.venv && chown -R $USERNAME:$USERNAME /app/.venv \
    && chown -R $USERNAME:$USERNAME /app

# Install dependencies including development dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Set UV cache path for the user
ENV UV_CACHE_DIR="/home/$USERNAME/.cache/uv"

# Set CUDA environment variables
ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    CUDA_HOME="/usr/local/cuda" \
    CUDA_PATH="/usr/local/cuda"

# Use non-root user for better security
USER $USERNAME

# No ENTRYPOINT or CMD for maximum flexibility
# To run in development with code mounting:
# docker run --gpus all -v $(pwd):/app -p 8000:8000 {{ project_name }}-dev python train.py
# or for Jupyter:
# docker run --gpus all -v $(pwd):/app -p 8888:8888 {{ project_name }}-dev jupyter lab --ip=0.0.0.0
