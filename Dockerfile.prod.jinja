{# Extract values from preset #}
{% if pytorch_cuda_preset == 'pytorch-2.9.0-cuda-12.6' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.9.0-cuda-13.0' %}
  {% set pytorch_version = '2.9.0' %}
  {% set cuda_version = '13.0' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.6' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.8.0-cuda-12.8' %}
  {% set pytorch_version = '2.8.0' %}
  {% set cuda_version = '12.8' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-12.6' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '12.6' %}
  {% set cudnn_version = '9.16.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.7.1-cuda-11.8' %}
  {% set pytorch_version = '2.7.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.6.0-cuda-12.4' %}
  {% set pytorch_version = '2.6.0' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.6.0-cuda-11.8' %}
  {% set pytorch_version = '2.6.0' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-12.4' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-12.1' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '9.1.0' %}
{% elif pytorch_cuda_preset == 'pytorch-2.5.1-cuda-11.8' %}
  {% set pytorch_version = '2.5.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-12.4' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '12.4' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-12.1' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.4.1-cuda-11.8' %}
  {% set pytorch_version = '2.4.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.3.1-cuda-12.1' %}
  {% set pytorch_version = '2.3.1' %}
  {% set cuda_version = '12.1' %}
  {% set cudnn_version = '8.9.7' %}
{% elif pytorch_cuda_preset == 'pytorch-2.3.1-cuda-11.8' %}
  {% set pytorch_version = '2.3.1' %}
  {% set cuda_version = '11.8' %}
  {% set cudnn_version = '8.9.7' %}
{% else %}
  {% set pytorch_version = pytorch_version %}
  {% set cuda_version = cuda_version %}
  {% set cudnn_version = cudnn_version %}
{% endif %}
# Reference: https://docs.astral.sh/uv/guides/integration/docker/
# Production version with UV tools and CUDA support (multi-stage build)

# Define CUDA/Python versions as build arguments
ARG CUDA_VERSION={{ cuda_version }}
ARG CUDNN_MAJOR={{ cudnn_version.split('.')[0] }}
ARG PYTHON_VERSION={{ python_version }}

# First, build the application in the `/app` directory with UV and CUDA
FROM nvidia/cuda:${CUDA_VERSION}-cudnn${CUDNN_MAJOR}-runtime-ubuntu22.04 as builder

# タイムゾーン設定を事前に指定して対話プロンプトを回避
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Tokyo \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# 必要なベースパッケージのみインストール
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    locales \
    curl \
    build-essential \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ロケールの設定
RUN echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen

# Copy UV from the official image (more efficient than installing via pip)
COPY --from=ghcr.io/astral-sh/uv:0.6.6 /uv /uvx /bin/

# APTでPython {{ python_version }}をインストール
RUN add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python{{ python_version }} \
    python{{ python_version }}-venv \
    python{{ python_version }}-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Make Python {{ python_version }} the default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python{{ python_version }} 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python{{ python_version }} 1

# Set environment variables for UV
ENV UV_COMPILE_BYTECODE=1 UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=0

WORKDIR /app
RUN --mount=type=cache,target=/root/.cache/uv \
    --mount=type=bind,source=uv.lock,target=uv.lock \
    --mount=type=bind,source=pyproject.toml,target=pyproject.toml \
    uv sync --frozen --no-install-project --no-dev
ADD . /app
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev


# Then, use a final image with minimal dependencies and CUDA
# Note: We need to redefine the ARGs in this stage
ARG CUDA_VERSION
ARG CUDNN_MAJOR
ARG PYTHON_VERSION
FROM nvidia/cuda:${CUDA_VERSION}-cudnn${CUDNN_MAJOR}-runtime-ubuntu22.04

# Accept build argument for username with a default value
ARG USERNAME=appuser

# タイムゾーン設定を事前に指定して対話プロンプトを回避
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Tokyo \
    LANG=C.UTF-8 \
    LC_ALL=C.UTF-8

# 必要なベースパッケージのみインストール
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone \
    && apt-get update && apt-get install -y --no-install-recommends \
    software-properties-common \
    locales \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ロケールの設定
RUN echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen && \
    locale-gen

# APTでPython {{ python_version }}をインストール
RUN add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y --no-install-recommends \
    python{{ python_version }} \
    python{{ python_version }}-venv \
    python{{ python_version }}-dev \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Make Python {{ python_version }} the default
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python{{ python_version }} 1 \
    && update-alternatives --install /usr/bin/python python /usr/bin/python{{ python_version }} 1
COPY --from=builder /bin/uv /bin/uv
COPY --from=builder /bin/uvx /bin/uvx

# Create a user with the provided username
RUN groupadd -r $USERNAME && useradd -r -g $USERNAME $USERNAME

# Copy the application from the builder
COPY --from=builder --chown=$USERNAME:$USERNAME /app /app

# Place executables in the environment at the front of the path
ENV PATH="/app/.venv/bin:$PATH"

# Set CUDA environment variables
ENV NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility \
    CUDA_HOME="/usr/local/cuda" \
    CUDA_PATH="/usr/local/cuda"

# Set working directory
WORKDIR /app

# Switch to the specified user
USER $USERNAME

# デフォルトのCMDを指定せず、docker run時にコマンドを渡せるようにする
# 実行例:
# docker run --gpus all {{ project_name }}-prod python train.py
# または
# docker run --gpus all {{ project_name }}-prod python -c "import torch; print(f'CUDA: {torch.cuda.is_available()}')"
