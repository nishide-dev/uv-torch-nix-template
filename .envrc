# .envrc - direnv configuration for automatic Nix environment loading
#
# このファイルにより、プロジェクトディレクトリに `cd` した瞬間に
# PyTorch/CUDA開発環境が自動的にアクティベートされます。
#
# 必要なツール:
#   - direnv (https://direnv.net/)
#   - nix-direnv (高速化のため推奨)
#
# セットアップ:
#   1. direnvをインストール
#   2. シェル設定ファイル（~/.bashrc or ~/.zshrc）に以下を追加:
#      eval "$(direnv hook bash)"  # bashの場合
#      eval "$(direnv hook zsh)"   # zshの場合
#   3. このディレクトリで: direnv allow
#
# NixOSユーザー:
#   - docs/NIX_SETUP.md を必ず参照してください
#   - /etc/nixos/configuration.nix でNVIDIAドライバーとnix-ldの有効化が必要です
#

# nix-direnvを使ってキャッシュを効かせ、環境構築を高速化
if ! has nix_direnv_version || ! nix_direnv_version 3.0.4; then
    source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.4/direnvrc" \
        "sha256-DzlYZ33mWF/Gs8DDeyjr8mnVmQGx7ASYqA5WlxwvBG4="
fi

# Nix Flakesを使用（CUDA環境を含む）
use flake

# .envファイルが存在する場合は読み込む
if [ -f .env ]; then
    dotenv .env
fi

# ============================================================================
# GPU/CUDA環境の状態確認（初回またはリロード時に表示）
# ============================================================================

# 色定義
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  PyTorch/CUDA Development Environment${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# CUDA環境変数の確認
if [ -n "$CUDA_HOME" ]; then
    echo -e "${GREEN}✓${NC} CUDA_HOME: $CUDA_HOME"
else
    echo -e "${YELLOW}⚠${NC} CUDA_HOME: Not set"
fi

if [ -n "$CUDNN_PATH" ]; then
    echo -e "${GREEN}✓${NC} CUDNN_PATH: $CUDNN_PATH"
else
    echo -e "${YELLOW}⚠${NC} CUDNN_PATH: Not set"
fi

# LD_LIBRARY_PATHの確認（GPUドライバー検出に重要）
if echo "$LD_LIBRARY_PATH" | grep -q "opengl-driver"; then
    echo -e "${GREEN}✓${NC} LD_LIBRARY_PATH: /run/opengl-driver/lib included"
else
    echo -e "${YELLOW}⚠${NC} LD_LIBRARY_PATH: /run/opengl-driver/lib not found"
    echo -e "  ${YELLOW}Note:${NC} GPU driver may not be accessible. See docs/NIX_SETUP.md"
fi

# NVIDIA Driver の確認
if command -v nvidia-smi &> /dev/null; then
    GPU_INFO=$(nvidia-smi --query-gpu=name --format=csv,noheader 2>/dev/null | head -1)
    if [ -n "$GPU_INFO" ]; then
        echo -e "${GREEN}✓${NC} GPU: $GPU_INFO"
        DRIVER_VERSION=$(nvidia-smi --query-gpu=driver_version --format=csv,noheader 2>/dev/null | head -1)
        echo -e "${GREEN}✓${NC} NVIDIA Driver: $DRIVER_VERSION"
    else
        echo -e "${YELLOW}⚠${NC} GPU: nvidia-smi found but no GPU detected"
    fi
else
    echo -e "${YELLOW}⚠${NC} nvidia-smi: Not found (GPU drivers not installed?)"
fi

# Python環境の確認
if command -v python &> /dev/null; then
    PYTHON_VERSION=$(python --version 2>&1 | cut -d' ' -f2)
    echo -e "${GREEN}✓${NC} Python: $PYTHON_VERSION"
fi

# uv の確認
if command -v uv &> /dev/null; then
    UV_VERSION=$(uv --version 2>&1 | cut -d' ' -f2)
    echo -e "${GREEN}✓${NC} uv: $UV_VERSION"
fi

echo ""
echo -e "${BLUE}Next steps:${NC}"
echo -e "  1. Install dependencies: ${GREEN}uv sync${NC}"
echo -e "  2. Verify CUDA:          ${GREEN}uv run python -c 'import torch; print(f\"CUDA: {torch.cuda.is_available()}\")'${NC}"
echo -e "  3. Run tests:            ${GREEN}uv run pytest${NC}"
echo ""
echo -e "${BLUE}Documentation:${NC}"
echo -e "  - docs/NIX_SETUP.md   : NixOS-specific setup (required for NixOS)"
echo -e "  - docs/CUDA_SETUP.md  : PyTorch/CUDA environment guide"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
